%% classify striatal cell types as in Peters et al., 2021


%% load dataset 
animal = 'JF020';
experiments = AP_find_experimentsJF(animal, 'rating', 1);
experiments =experiments(1); 
[ephys_path, ephys_exists] = AP_cortexlab_filenameJF(animal, experiments.day, experiments.experiment(2), 'ephys', 1);
[ephysap_path, ] = AP_cortexlab_filenameJF(animal, experiments.day, experiments.experiment(2), 'ephys_qp', 1);
for iDay = 1:size(foldersAll, 1)
    
    templates = readNPY([ephys_path, filesep, 'templates.npy']);
    channel_positions = readNPY([ephys_path, filesep, 'channel_positions.npy']);
    spike_times = double(readNPY([ephys_path, filesep, 'spike_times.npy'])); % sample rate hard-coded as 30000 - should load this in from params 
    spike_templates = readNPY([ephys_path, filesep, 'spike_templates.npy']) + 1; % 0-idx -> 1-idx
    template_amplitude = readNPY([ephys_path, filesep, 'amplitudes.npy']);
    spike_clusters = readNPY([ephys_path, filesep, 'spike_clusters.npy']) + 1;
    pc_features = readNPY([ephys_path, filesep, 'pc_features.npy']) ;
    pc_feature_ind = readNPY([ephys_path, filesep, 'pc_feature_ind.npy']) + 1;
end
%% parameters
param = struct;
% refractory period parameters
param.tauR = 0.0010; %refractory period time (s)
param.tauC = 0.0002; %censored period time (s)
param.maxRPVviolations = 0.2;
% percentage spikes missing parameters 
param.maxPercSpikesMissing = 30;
param.computeTimeChunks = 0;
% number of spikes
param.minNumSpikes = 300;
% waveform parameters
param.maxNPeaks = 2;
param.maxNTroughs = 1;
param.axonal = 0; 

param.minAmplitude = 77; 
param.plotThis = 0;
param.rawFolder = d1_rawfolder;

param.deltaTimeChunk = NaN; 
param.ephys_sample_rate = 30000;
param.nChannels = 385;
param.nRawSpikesToExtract = 100; 
param.nChannelsIsoDist = NaN;
param.computeDistanceMetrics = 0;
param.isoDmin = NaN;
param.lratioMin = NaN;
param.ssMin = NaN; 
param.ACGbinSize
param.ACGduration
%% compute quality metrics 
[qMetric, goodUnits] = bc_runAllQualityMetrics(param, spike_times{iDay}, spike_templates{iDay}, ...
    templates{iDay}, template_amplitude{iDay},pc_features{iDay},pc_feature_ind{iDay});

%% compute ephys properties 
bc_computeAllEphysProperties()
%% classify striatal cells 
bc_classifyStriatalCells()